<template>
  <div class="min-h-screen bg-gradient-to-br from-orange-50 via-white to-pink-50">
    <div class="container mx-auto px-4 py-8">
      <!-- Back Button -->
      <div class="mb-6">
        <button 
          @click="$router.back()"
          class="flex items-center space-x-2 text-gray-600 hover:text-orange-600 transition-colors"
        >
          <span>‚Üê</span>
          <span>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏•‡∏á‡∏≤‡∏ô</span>
        </button>
      </div>

      <!-- Form Card -->
      <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-sm p-8">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô‡πÉ‡∏´‡∏°‡πà</h1>
          <p class="text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>

        <form @submit.prevent="createWork" class="space-y-8">
          <!-- Basic Information -->
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á <span class="text-red-500">*</span>
              </label>
              <input 
                v-model="form.title"
                type="text" 
                placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à"
                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                required
              />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó <span class="text-red-500">*</span>
              </label>
              <select 
                v-model="form.category"
                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                required
              >
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                <option value="action">‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡πà‡∏ô</option>
                <option value="romance">‡πÇ‡∏£‡πÅ‡∏°‡∏ô‡∏ï‡∏¥‡∏Å</option>
                <option value="comedy">‡∏ï‡∏•‡∏Å</option>
                <option value="drama">‡∏î‡∏£‡∏≤‡∏°‡πà‡∏≤</option>
                <option value="fantasy">‡πÅ‡∏ü‡∏ô‡∏ï‡∏≤‡∏ã‡∏µ</option>
                <option value="horror">‡∏™‡∏¢‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç</option>
                <option value="mystery">‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô</option>
                <option value="slice-of-life">‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</option>
              </select>
            </div>
          </div>

          <!-- Cover Image -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              ‡∏£‡∏π‡∏õ‡∏õ‡∏Å
            </label>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-orange-400 transition-colors">
              <div v-if="!form.coverImage" class="space-y-4">
                <div class="w-16 h-16 mx-auto bg-gray-100 rounded-full flex items-center justify-center">
                  <span class="text-2xl">üñºÔ∏è</span>
                </div>
                <div>
                  <p class="text-gray-600 mb-2">‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
                  <input 
                    type="file" 
                    accept="image/*"
                    @change="handleImageUpload"
                    class="hidden"
                    ref="fileInput"
                  />
                  <button 
                    type="button"
                    @click="$refs.fileInput.click()"
                    class="bg-orange-100 text-orange-700 px-4 py-2 rounded-lg hover:bg-orange-200 transition-colors"
                  >
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
                  </button>
                </div>
              </div>
              <div v-else class="space-y-4">
                <img :src="form.coverPreview" alt="Cover preview" class="w-32 h-40 mx-auto object-cover rounded-lg" />
                <button 
                  type="button"
                  @click="removeCoverImage"
                  class="text-red-600 hover:text-red-800"
                >
                  ‡∏•‡∏ö‡∏£‡∏π‡∏õ
                </button>
              </div>
            </div>
          </div>

          <!-- Description -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠ <span class="text-red-500">*</span>
            </label>
            <textarea 
              v-model="form.description"
              placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô"
              rows="5"
              maxlength="500"
              class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
              :class="{ 'border-red-300': form.description?.length > 500 }"
              required
            ></textarea>
            <p class="text-sm mt-1" :class="{ 'text-red-500': form.description?.length > 500, 'text-gray-500': form.description?.length <= 500 }">
              {{ form.description?.length || 0 }}/500 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
            </p>
          </div>

          <!-- Tags -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              ‡πÅ‡∏ó‡πá‡∏Å
            </label>
            <div class="space-y-3">
              <div class="flex flex-wrap gap-2">
                <span 
                  v-for="tag in form.tags" 
                  :key="tag"
                  class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm flex items-center space-x-1"
                >
                  <span>{{ tag }}</span>
                  <button 
                    type="button"
                    @click="removeTag(tag)"
                    class="text-orange-600 hover:text-orange-800"
                  >
                    √ó
                  </button>
                </span>
              </div>
              <div class="flex space-x-2">
                <input 
                  v-model="newTag"
                  @keyup.enter="addTag"
                  type="text" 
                  placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢, ‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û"
                  class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                />
                <button 
                  type="button"
                  @click="addTag"
                  class="bg-orange-100 text-orange-700 px-4 py-3 rounded-lg hover:bg-orange-200 transition-colors"
                >
                  ‡πÄ‡∏û‡∏¥‡πà‡∏°
                </button>
              </div>
            </div>
          </div>

          <!-- Settings -->
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà
              </label>
              <select 
                v-model="form.publishStatus"
                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
              >
                <option value="draft">‡∏£‡πà‡∏≤‡∏á</option>
                <option value="published">‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</option>
                <option value="pending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ‡∏≠‡∏≤‡∏¢‡∏∏‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô
              </label>
              <select 
                v-model="form.ageRating"
                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
              >
                <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏û‡∏®‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏¢</option>
                <option value="teen">13+ ‡∏õ‡∏µ</option>
                <option value="mature">18+ ‡∏õ‡∏µ</option>
              </select>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex space-x-4 pt-6">
            <button 
              type="button"
              @click="$router.back()"
              class="flex-1 bg-gray-100 text-gray-700 py-4 rounded-lg font-medium hover:bg-gray-200 transition-colors"
            >
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button 
              type="submit"
              :disabled="!isFormValid || isSubmitting"
              class="flex-1 bg-gradient-to-r from-orange-400 to-pink-400 text-white py-4 rounded-lg font-medium hover:shadow-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
            >
              <div v-if="isSubmitting" class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
              <span>{{ isSubmitting ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô' }}</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</template>

<script setup>
import { useWorksStore } from '~/stores/works'

definePageMeta({
  layout: 'default'
})

const worksStore = useWorksStore()
const router = useRouter()

// Form data
const form = ref({
  title: '',
  category: '',
  description: '',
  tags: [],
  publishStatus: 'draft',
  ageRating: 'all',
  coverImage: null,
  coverPreview: null
})

const newTag = ref('')
const isSubmitting = ref(false)

// Computed
const isFormValid = computed(() => {
  return form.value.title.trim() !== '' && 
         form.value.category !== '' && 
         form.value.description.trim() !== '' &&
         form.value.description.length <= 500
})

// Methods
const handleImageUpload = (event) => {
  const file = event.target.files[0]
  if (file) {
    if (file.size > 5 * 1024 * 1024) { // 5MB limit
      alert('‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB')
      return
    }
    
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
    if (!allowedTypes.includes(file.type)) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (JPEG, PNG, GIF, WebP)')
      return
    }
    
    form.value.coverImage = file
    
    // Create preview
    const reader = new FileReader()
    reader.onload = (e) => {
      form.value.coverPreview = e.target.result
    }
    reader.readAsDataURL(file)
  }
}

const removeCoverImage = () => {
  form.value.coverImage = null
  form.value.coverPreview = null
  // Reset file input
  if (process.client) {
    const fileInput = document.querySelector('input[type="file"]')
    if (fileInput) fileInput.value = ''
  }
}

const addTag = () => {
  const tag = newTag.value.trim()
  if (tag && !form.value.tags.includes(tag) && form.value.tags.length < 10) {
    form.value.tags.push(tag)
    newTag.value = ''
  }
}

const removeTag = (tagToRemove) => {
  form.value.tags = form.value.tags.filter(tag => tag !== tagToRemove)
}

const createWork = async () => {
  if (!isFormValid.value || isSubmitting.value) return
  
  isSubmitting.value = true
  
  try {
    const workData = {
      title: form.value.title.trim(),
      category: form.value.category,
      description: form.value.description.trim(),
      tags: form.value.tags,
      publishStatus: form.value.publishStatus,
      ageRating: form.value.ageRating,
      // Note: In a real app, you'd upload the image to a server first
      coverImage: form.value.coverPreview
    }
    
    await worksStore.createWork(workData)
    
    // Show success message
    alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!')
    
    // Redirect to works page
    await router.push('/writer')
  } catch (error) {
    console.error('Error creating work:', error)
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà')
  } finally {
    isSubmitting.value = false
  }
}

// Handle keyboard shortcuts
const handleKeydown = (event) => {
  if (event.key === 'Enter' && event.metaKey) {
    createWork()
  }
}

onMounted(() => {
  if (process.client) {
    document.addEventListener('keydown', handleKeydown)
  }
})

onUnmounted(() => {
  if (process.client) {
    document.removeEventListener('keydown', handleKeydown)
  }
})
</script>

<style scoped>
/* Custom styles */
</style>
